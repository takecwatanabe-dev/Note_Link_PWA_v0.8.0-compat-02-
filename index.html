<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NOTE LINK — v0.8.0 / B-REL6-HF1</title>
<style>
  :root{ --a4w:794px; --a4h:1123px; } /* 210×297mm 相当 @96dpi */
  html,body{height:100%}
  body{margin:0;background:#1b1b1b;color:#f4f4f4;font-family:system-ui,"Noto Sans JP",sans-serif}
  .topbar{height:44px;display:flex;align-items:center;gap:12px;padding:0 14px;background:#111;border-bottom:1px solid #2a2a2a}
  .ver{font-weight:700;letter-spacing:.02em}
  .kbd{font-size:.82rem;color:#9aa}
  .wrap{display:flex}
  .canvas-wrap{position:relative;flex:1;display:flex;justify-content:center;align-items:flex-start;padding:12px 0;overflow:auto;height:calc(100vh - 44px)}
  .a4-stage{
    position:relative;background:#fff;border:1px solid #ddd;box-shadow:0 2px 12px rgba(0,0,0,.35);
    width:var(--a4w);height:var(--a4h);
    touch-action:none;user-select:none;
  }
  canvas{position:absolute;left:0;top:0;width:100%;height:100%;image-rendering:crisp-edges;touch-action:none;user-select:none}
  #overlay{pointer-events:none}

  /* 消しゴム設定ダイアログ（内部UIのみ追加） */
  dialog#eraserDialog{
    border:none;border-radius:12px;padding:0;max-width:360px;background:#121212;color:#eee;
    box-shadow:0 14px 60px rgba(0,0,0,.6);width:min(92vw,360px)
  }
  .dlg-hd{padding:14px 16px;border-bottom:1px solid #2b2b2b;font-weight:700}
  .dlg-bd{padding:12px 16px;display:grid;gap:14px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .row .label{font-size:.95rem;color:#ccc}
  .seg{display:inline-flex;border:1px solid #3a3a3a;border-radius:10px;overflow:hidden}
  .seg button{background:#1b1b1b;color:#eee;border:none;padding:8px 10px;cursor:pointer}
  .seg button[aria-pressed="true"]{background:#2d2d2d;font-weight:700}
  .stepper{display:inline-flex;align-items:center;gap:6px}
  .stepper button{width:34px;height:34px;border-radius:8px;border:1px solid #3a3a3a;background:#1b1b1b;color:#eee;cursor:pointer}
  input[type="range"]{width:180px}
  .mmnote{font-size:.82rem;color:#9aa}
  .dlg-ft{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid #2b2b2b}
  .dlg-ft button{border:1px solid #3a3a3a;background:#1b1b1b;color:#eee;border-radius:10px;padding:8px 12px;cursor:pointer}

  @media print{
    body{background:#fff;color:#000}
    .topbar{display:none}
    .canvas-wrap{padding:0;height:auto}
    .a4-stage{width:210mm;height:297mm;border:none;box-shadow:none;margin:0 auto}
  }
</style>
</head>
<body oncontextmenu="return false">
  <div class="topbar">
    <div class="ver">NOTE LINK — v0.8.0 / <strong>B-REL6-HF1</strong></div>
    <div class="kbd">直線: Shift ／ ツール: 1=ペン 2=マーカー 3=消しゴム ／ 設定: Ctrl+E（モバイルは長押し）</div>
  </div>

  <div class="wrap">
    <main class="canvas-wrap">
      <section class="a4-stage" id="stage">
        <canvas id="note"></canvas>
        <canvas id="overlay"></canvas>
      </section>
    </main>
  </div>

  <!-- 消しゴム設定ダイアログ（内部UIだけ追加） -->
  <dialog id="eraserDialog">
    <div class="dlg-hd">消しゴム 設定</div>
    <div class="dlg-bd">
      <div class="row">
        <div class="label">形状</div>
        <div class="seg" role="group" aria-label="Eraser Shape">
          <button id="shapeCircle" aria-pressed="true">円</button>
          <button id="shapeSquare" aria-pressed="false">四角</button>
        </div>
      </div>
      <div class="row">
        <div class="label">サイズ</div>
        <div class="stepper">
          <button id="sizeDec" aria-label="サイズ縮小">–</button>
          <input type="range" id="sizeRange" min="4" max="200" value="24" />
          <button id="sizeInc" aria-label="サイズ拡大">+</button>
        </div>
      </div>
      <div class="row">
        <div class="label">ガイド表示</div>
        <div class="seg">
          <button id="guideOn"  aria-pressed="true">ON</button>
          <button id="guideOff" aria-pressed="false">OFF</button>
        </div>
      </div>
      <div class="mmnote" id="sizeInfo">現在：24 px（約 6.35 mm）</div>
      <div class="mmnote">ショートカット：形状 R ／ サイズ [ / ] ／ ダイアログ Ctrl+E ／ モバイル長押し</div>
    </div>
    <div class="dlg-ft">
      <button id="dlgClose">閉じる</button>
    </div>
  </dialog>

<script>
(() => {
  /* ===== 既定（UI不変／内部だけ） ===== */
  const DEFAULTS = {
    penColor: '#000000',
    markerColor: '#FFFF00',
    markerAlpha: 0.5,
    penWidth: 2,
    markerWidth: 18,
    eraser: { shape: 'circle', size: 24, guide: true }
  };

  const stage = document.getElementById('stage');
  const note  = document.getElementById('note');
  const ov    = document.getElementById('overlay');
  const ctx   = note.getContext('2d');
  const octx  = ov.getContext('2d');

  const DPR = () => Math.max(1, window.devicePixelRatio || 1);

  /* ---- A4領域サイズ同期（rAF二段＋ResizeObserver） ---- */
  function syncSize(){
    const fix = ()=>{
      const r = stage.getBoundingClientRect(), d = DPR();
      const w = Math.max(2, Math.floor(r.width  * d));
      const h = Math.max(2, Math.floor(r.height * d));
      if(note.width!==w)  note.width=w;
      if(note.height!==h) note.height=h;
      if(ov.width!==w)    ov.width=w;
      if(ov.height!==h)   ov.height=h;
      note.style.width=r.width+'px'; note.style.height=r.height+'px';
      ov.style.width=r.width+'px';   ov.style.height=r.height+'px';
      ctx.lineCap=ctx.lineJoin='round';
    };
    requestAnimationFrame(()=>requestAnimationFrame(fix));
  }
  new ResizeObserver(syncSize).observe(stage); syncSize();

  /* ---- 状態 ---- */
  const state = {
    tool:'pen', drawing:false,
    startX:0,startY:0,lastX:0,lastY:0,
    straightActive:false  // ★ このStrokeの間だけ直線
  };

  // 色・太さ
  let penColor=DEFAULTS.penColor, penWidth=DEFAULTS.penWidth;
  let markerColor=DEFAULTS.markerColor, markerWidth=DEFAULTS.markerWidth, markerAlpha=DEFAULTS.markerAlpha;
  const eraser = { ...DEFAULTS.eraser };

  /* ---- スタイル適用 ---- */
  function useStyle(tool){
    if(tool==='pen'){
      ctx.globalCompositeOperation='source-over';
      ctx.globalAlpha=1;
      ctx.strokeStyle=penColor;
      ctx.lineWidth=penWidth*DPR();
    }else if(tool==='marker'){
      ctx.globalCompositeOperation='source-over';
      ctx.globalAlpha=markerAlpha;        // 直線/曲線で統一
      ctx.strokeStyle=markerColor;
      ctx.lineWidth=markerWidth*DPR();
    }else{ // eraser
      ctx.globalCompositeOperation='destination-out';
      ctx.globalAlpha=1;
      ctx.lineWidth=eraser.size*DPR();
    }
    ctx.lineCap=ctx.lineJoin='round';
  }

  /* ---- 座標 ---- */
  function pos(e){
    const r = note.getBoundingClientRect(), d = DPR();
    return { x:(e.clientX - r.left)*d, y:(e.clientY - r.top)*d };
  }

  /* ---- Stroke ---- */
  function begin(x,y){
    state.drawing=true;
    state.startX=state.lastX=x;
    state.startY=state.lastY=y;
    ctx.beginPath(); ctx.moveTo(x,y);
  }
  function drag(x,y){
    ctx.beginPath();
    if(state.straightActive){ ctx.moveTo(state.startX, state.startY); }
    else{ ctx.moveTo(state.lastX, state.lastY); }
    ctx.lineTo(x,y); ctx.stroke();
    state.lastX=x; state.lastY=y;
  }
  function end(){ state.drawing=false; }

  /* ---- ガイド（消しゴム時のみ） ---- */
  function guide(x,y){
    octx.clearRect(0,0,ov.width,ov.height);
    if(state.tool!=='eraser' || !eraser.guide) return;
    const s = eraser.size*DPR();
    octx.save();
    octx.strokeStyle='rgba(0,0,0,.35)'; octx.lineWidth=2*DPR(); octx.setLineDash([6*DPR(),6*DPR()]);
    if(eraser.shape==='circle'){ octx.beginPath(); octx.arc(x,y,s/2,0,Math.PI*2); octx.stroke(); }
    else{ octx.strokeRect(x-s/2,y-s/2,s,s); }
    octx.restore();
  }

  /* ---- 入力（canvasのみ・最小構成） ---- */
  note.addEventListener('pointerdown', (e)=>{
    e.preventDefault();
    note.setPointerCapture?.(e.pointerId);
    const {x,y} = pos(e);
    state.straightActive = !!e.shiftKey; // ★このStrokeに限り有効
    if(state.tool==='eraser'){
      useStyle('eraser');
      const s = eraser.size*DPR();
      if(eraser.shape==='circle'){ ctx.beginPath(); ctx.arc(x,y,s/2,0,Math.PI*2); ctx.fill(); }
      else{ ctx.fillRect(x-s/2,y-s/2,s,s); }
      guide(x,y);
      return;
    }
    useStyle(state.tool);
    begin(x,y);
    guide(x,y);
  }, {passive:false});

  note.addEventListener('pointermove', (e)=>{
    const {x,y} = pos(e);
    if(state.tool==='eraser'){
      guide(x,y);
      if(e.buttons & 1){
        useStyle('eraser');
        const s = eraser.size*DPR();
        if(eraser.shape==='circle'){ ctx.beginPath(); ctx.arc(x,y,s/2,0,Math.PI*2); ctx.fill(); }
        else{ ctx.fillRect(x-s/2,y-s/2,s,s); }
      }
      return;
    }
    if(!state.drawing){ guide(x,y); return; }
    useStyle(state.tool);
    drag(x,y);
    guide(x,y);
  }, {passive:false});

  function endAll(){
    if(state.drawing) end();
    octx.clearRect(0,0,ov.width,ov.height);
  }
  note.addEventListener('pointerup', endAll, {passive:true});
  note.addEventListener('pointercancel', endAll, {passive:true});
  note.addEventListener('pointerleave', endAll, {passive:true});

  /* ---- ツール（既存UI前提。補助ホットキーのみ） ---- */
  addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.key.toLowerCase()==='e'){ e.preventDefault(); openDlg(); }
    if(e.key==='1') state.tool='pen';
    if(e.key==='2') state.tool='marker';
    if(e.key==='3') state.tool='eraser';
    if(e.key.toLowerCase()==='r'){ eraser.shape = (eraser.shape==='circle' ? 'square':'circle'); syncDlg(); }
    if(e.key==='['){ eraser.size=Math.max(4,eraser.size-5); syncDlg(); }
    if(e.key===']'){ eraser.size=Math.min(200,eraser.size+5); syncDlg(); }
  });

  /* ---- 消しゴム設定ダイアログ（内部UIのみ） ---- */
  const dlg = document.getElementById('eraserDialog');
  const $ = (id)=>document.getElementById(id);
  const pxToMm = (px)=>px*25.4/96;
  function openDlg(){ syncDlg(); dlg.showModal?.(); }
  function closeDlg(){ dlg.close?.(); }
  function syncDlg(){
    $('shapeCircle').setAttribute('aria-pressed', eraser.shape==='circle');
    $('shapeSquare').setAttribute('aria-pressed', eraser.shape==='square');
    $('sizeRange').value = eraser.size;
    $('sizeInfo').textContent = `現在：${eraser.size} px（約 ${(pxToMm(eraser.size)).toFixed(2)} mm）`;
    $('guideOn').setAttribute('aria-pressed', eraser.guide===true);
    $('guideOff').setAttribute('aria-pressed', eraser.guide===false);
  }
  $('shapeCircle').addEventListener('click', ()=>{ eraser.shape='circle'; syncDlg(); });
  $('shapeSquare').addEventListener('click', ()=>{ eraser.shape='square'; syncDlg(); });
  $('sizeDec').addEventListener('click', ()=>{ eraser.size=Math.max(4,eraser.size-5); syncDlg(); });
  $('sizeInc').addEventListener('click', ()=>{ eraser.size=Math.min(200,eraser.size+5); syncDlg(); });
  $('sizeRange').addEventListener('input', (e)=>{ eraser.size=+e.target.value; syncDlg(); });
  $('guideOn').addEventListener('click', ()=>{ eraser.guide=true; syncDlg(); });
  $('guideOff').addEventListener('click', ()=>{ eraser.guide=false; syncDlg(); });
  $('dlgClose').addEventListener('click', closeDlg);

  /* モバイル：消しゴム選択中は長押しで設定 */
  let longPress=null;
  stage.addEventListener('pointerdown', ()=>{ clearTimeout(longPress); longPress=setTimeout(()=>{ if(state.tool==='eraser') openDlg(); }, 600); }, {passive:true});
  stage.addEventListener('pointermove', ()=>{ clearTimeout(longPress); }, {passive:true});
  stage.addEventListener('pointerup',   ()=>{ clearTimeout(longPress); }, {passive:true});
  stage.addEventListener('pointercancel',()=>{ clearTimeout(longPress); }, {passive:true});

  /* 初期はペン（黒）、マーカーは黄50% */
})();
</script>
</body>
</html>
