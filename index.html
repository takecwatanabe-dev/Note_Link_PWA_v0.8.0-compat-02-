<!doctype html><html lang="ja"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Note Link — v0.8.0-compat-02b-dbg-b2</title>
<style>
:root{
  --ink:#e6f1ff; --ink-dim:#9bd6e9; --bg:#0b1020;
  --panel:#101827; --accent:#3f78ff; --ok:#20e3c2; --muted:#2a3550;
  --shadow:0 10px 24px rgba(0,0,0,.45);
  --topbar-h:44px; --toolbar-w:56px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
  -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; touch-action:none;}
/* 固定ヘッダ（トップバー） */
header.topbar{
  position:fixed; top:0; left:0; right:0; z-index:2000;
  height:var(--topbar-h); display:flex; align-items:center; gap:8px; padding:0 10px; font-size:12px; color:#fff;
  background:linear-gradient(0deg,rgba(42,84,255,.16),rgba(42,84,255,.16)),var(--accent);
  border-bottom:1px solid rgba(255,255,255,.15)
}
.topbar .sp{flex:1}
.topbar .btn{height:28px;padding:0 10px;border-radius:10px;background:rgba(255,255,255,.2);
  border:1px solid rgba(255,255,255,.22);color:#fff;display:inline-flex;align-items:center}
.topbar .btn:active{transform:translateY(1px)} .build{opacity:.8}

/* レイアウト */
#wrap{position:relative;height:100%;padding-top:var(--topbar-h)}
#stage{position:absolute; inset:0; padding-left:var(--toolbar-w)}
#viewport{position:absolute; inset:0; transform-origin:0 0; touch-action:none}

/* サイドバー（ツールバー） */
.sidebar{
  position:fixed; z-index:1500; left:0; top:var(--topbar-h); bottom:0; width:var(--toolbar-w);
  display:flex; flex-direction:column; align-items:center;
  background:rgba(0,0,0,.86); box-shadow:0 0 0 1px var(--muted) inset;
}
.sidebar .rail{width:100%; padding:6px; display:flex; flex-direction:column; gap:8px}
.tool{
  display:grid; place-items:center; width:100%; height:36px; border-radius:10px; cursor:pointer; user-select:none;
  background:rgba(22,26,38,.75); border:1px solid rgba(50,60,100,.6);
  outline:1px solid rgba(79,124,255,.35); box-shadow:0 0 0 2px rgba(0,0,0,.12)
}
.tool:hover{outline:1px solid rgba(79,124,255,.5)}
.tool.active{outline:1px solid var(--ok)}
.tool svg{width:18px;height:18px;stroke:var(--ink);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.sidebar.collapsed .rail > .tool:not([data-tool="toggle"]){display:none}
.tool[data-tool="toggle"] svg{transition:transform .2s}
.sidebar.collapsed .tool[data-tool="toggle"] svg{transform:rotate(180deg)}

/* 設定パネル */
.panel{
  position:absolute; z-index:1400; left:70px; top:calc(var(--topbar-h) + 10px);
  min-width:280px; max-width:320px; padding:8px 12px 10px; border-radius:14px; color:var(--ink);
  background:var(--panel); border:1px solid rgba(255,255,255,.14); box-shadow:var(--shadow);
  display:none; user-select:none; max-height:calc(100vh - var(--topbar-h) - 24px); overflow:auto
}
.panel.show{display:block}
.panel .handle{position:sticky; top:0; display:flex; align-items:center; gap:8px; padding:8px 12px; margin:-8px -12px 8px;
  background:var(--panel); border-bottom:1px solid #ffffff14; border-radius:14px 14px 0 0; cursor:grab}
#panelTool{flex:1;font-weight:600;font-size:14px;text-align:left}
.panel .close{margin-left:auto;height:26px;padding:0 10px;border-radius:8px;border:1px solid #ffffff2e;background:#ffffff14;color:var(--ink);font-size:14px}
.panel .row{display:flex; align-items:center; gap:10px; margin:6px 0}
.panel .row label{width:100px;font-size:12px;color:var(--ink-dim)}
.panel .row input[type="range"]{flex:1; min-width:120px}
.panel .row button{height:26px;padding:0 8px;border-radius:8px;border:1px solid #ffffff2e;background:#ffffff14;color:#fff;font-size:12px}

/* キャンバス */
#grid,#guide,#paint{position:absolute; left:var(--toolbar-w); top:0; right:0; bottom:0}
#grid,#guide{z-index:100; pointer-events:none}
#paint{z-index:80; touch-action:none; -webkit-touch-callout:none}

/* テキスト */
.text-layer{position:absolute;left:var(--toolbar-w);top:0;right:0;bottom:0;z-index:120;pointer-events:none}
.note-text{position:absolute;min-width:64px;min-height:28px;padding:6px 8px;color:#eaf3ff;background:transparent;
  outline:1px dashed rgba(255,255,255,.25);border-radius:6px;pointer-events:auto}
.note-text[contenteditable="true"]:focus{outline:2px solid var(--ok)}
.note-text .del{position:absolute;right:-8px;top:-10px;font-size:11px;color:#fff;background:#0008;border:1px solid #fff3;border-radius:8px;padding:2px 6px;display:none}
.note-text:focus-within .del{display:block}

/* ツールチップ */
[data-tip]{position:relative}
[data-tip]::after{content:attr(data-tip);position:absolute;left:48px;top:50%;transform:translateY(-50%);
  background:#222a;color:#fff;font-size:12px;padding:4px 8px;border-radius:8px;white-space:nowrap;pointer-events:none;opacity:0;transition:.15s}
[data-tip]:hover::after{opacity:1}
.sidebar .tool[data-tool="settings"][data-tip]::after{left:8px;top:auto;bottom:calc(100% + 8px);transform:none;z-index:1800}

@media print{
  header.topbar,.sidebar,.panel,[data-tip]::after{display:none!important}
  #stage{padding-left:0!important} body,html,#wrap{height:auto}
}

/* 診断ログ（?debug=1の時だけ出す） */
#diag{position:fixed; left:56px; right:8px; bottom:8px; z-index:5000; display:none}
#diag .card{background:#0b1325ee; border:1px solid #ffffff22; border-radius:12px; box-shadow:var(--shadow); padding:8px}
#diag .hd{display:flex; align-items:center; gap:8px; margin-bottom:6px}
#diag .hd strong{font-size:13px}
#diag textarea{width:100%; height:140px; resize:vertical; font-family:ui-monospace,Consolas,monospace; font-size:12px; color:#cfe6ff; background:#0008; border:1px solid #ffffff1f; border-radius:8px; padding:6px}
#diag .row{display:flex; gap:8px; margin-top:6px}
#diag button{height:28px; padding:0 10px; border-radius:8px; border:1px solid #ffffff2e; background:#ffffff14; color:#fff; font-size:12px}
</style>
</head>
<body>
<header class="topbar" id="topbar">
  <strong id="verText">Note Link v0.8.0 / B-FIX1</strong><!-- ←左上のバージョン -->
  <span class="sp"></span>
  <button class="btn" id="btnZoomOut">−</button>
  <button class="btn" id="btnZoomReset">100%</button>
  <button class="btn" id="btnZoomIn">＋</button>
  <button class="btn" id="btnUndo">undo</button>
  <button class="btn" id="btnRedo">redo</button>
  <button class="btn" id="btnPrint">印刷</button>
  <button class="btn" id="btnPng">PNG</button>
  <button class="btn" id="btnShare">共有</button>
  <span class="build" id="buildText">build: compat-02b-dbg-b2</span><!-- ←右上のビルド名 -->
</header>

<aside class="sidebar" id="sidebar">
  <div class="rail">
    <button class="tool" id="btnSidebarToggle" data-tool="toggle" data-tip="ツールバーの開閉">
      <svg viewBox="0 0 24 24"><path d="M5 15 L12 7 L19 15 M19 15 L5 15"/></svg>
    </button>
    <button class="tool" data-tool="pen" data-tip="ペン">
      <svg viewBox="0 0 24 24"><path d="M3 21l4-1 12-12-3-3L4 17l-1 4zM14 6l3 3"/></svg>
    </button>
    <button class="tool" data-tool="marker" data-tip="マーカー">
      <svg viewBox="0 0 24 24"><path d="M3 16l10-10 5 5-10 10-5 1 1-6zM13 6l5 5"/></svg>
    </button>
    <button class="tool" data-tool="eraser" data-tip="消しゴム">
      <svg viewBox="0 0 24 24"><path d="M3 15l8-8 6 6-6 6H7zM13 7l4 4"/></svg>
    </button>
    <button class="tool" data-tool="hand" data-tip="選択/パン">
      <svg viewBox="0 0 24 24"><path d="M9 11V6a2 2 0 0 1 4 0v5M13 11V5a2 2 0 1 1 4 0v8M9 11a2 2 0 0 1 4 0v8l-2 2-4-4-2-6 2-1z"/></svg>
    </button>
    <button class="tool" data-tool="keyboard" data-tip="テキスト">
      <svg viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="10" rx="2"></rect><path d="M7 10h10M5 13h14"/></svg>
    </button>
    <button class="tool" data-tool="settings" data-tip="ツール設定（表示/非表示）">
      <svg viewBox="0 0 24 24"><path d="M12 7.5a4.5 4.5 0 1 1 0 9 4.5 4.5 0 0 1 0-9zM4 13h2l1 2-1 2H4l-1-2 1-2zm14 0h2l1 2-1 2h-2l-1-2 1-2zM8 4h2l2 1 2-1h2l1 2-1 2h-2l-2-1-2 1H8L7 6l1-2z"/></svg>
    </button>
  </div>
</aside>

<!-- 設定パネル -->
<div class="panel" id="panel">
  <div class="handle" id="panelHandle">
    <div id="panelTool">-</div>
    <button class="close" id="panelClose" title="閉じる">☒</button>
  </div>
  <div class="row"><label>色</label><input type="color" id="uiColor" value="#cbe58a"></div>
  <div class="row" id="rowSize"><label>太さ</label><input type="range" min="1" max="60" value="4" id="uiSize"><span id="uiSizeVal">4px (1.06 mm)</span></div>
  <div class="row" id="rowAlpha"><label>不透明度</label><input type="range" min="10" max="100" value="100" id="uiAlpha"><span id="uiAlphaVal">100%</span></div>
  <div class="row" id="rowLineCap"><label>端の形</label>
    <select id="uiCap"><option value="butt">□ 角</option><option value="round">● 丸</option></select>
  </div>
  <div class="row" id="rowStraight"><label>直線モード</label>
    <label><input type="checkbox" id="uiStraight">（モバイル / 15°刻み）</label>
    <label><input type="checkbox" id="uiGridFirst">グリッド優先</label>
  </div>
  <div class="row" id="rowGrid"><label>グリッド</label>
    <label><input type="checkbox" id="uiGrid"> 表示</label>
    <select id="uiGridStep"><option value="5">5mm</option><option value="10" selected>10mm</option></select>
    <input type="color" id="uiGridColor" value="#3a4f7a"/>
  </div>
  <div class="row" id="rowPenExt">
    <label>ペン拡張</label>
    <label><input type="checkbox" id="uiPalm" checked> パーム除外</label>
    <label><input type="checkbox" id="uiPressure" checked> 圧力</label>
    <label><input type="checkbox" id="uiTilt" checked> 傾き</label>
  </div>
  <div class="row" id="rowTextOps" style="display:none; gap:6px">
    <label>テキスト</label>
    <button id="btnTextAdd"  title="テキストを追加">追加</button>
    <button id="btnTextBold" title="太字">太字</button>
    <button id="btnTextIt"   title="斜体">斜体</button>
    <button id="btnTextDel"  title="選択削">選択削</button>
    <button id="btnTextBoxDel" title="枠削">枠削</button>
  </div>
</div>

<div id="wrap"><div id="stage">
  <div id="viewport">
    <canvas id="grid"></canvas>
    <canvas id="guide"></canvas>
    <canvas id="paint"></canvas>
    <div class="text-layer" id="textLayer"></div>
  </div>
</div></div>

<!-- 診断ログ -->
<div id="diag">
  <div class="card">
    <div class="hd"><strong>診断ログ</strong><span id="env"></span></div>
    <textarea id="log" spellcheck="false"></textarea>
    <div class="row">
      <button id="btnCopy">ログをコピー</button>
      <button id="btnClear">クリア</button>
    </div>
  </div>
</div>

<script>
/* ====== 便利関数＆診断 ====== */
const qs=(s)=>document.querySelector(s), $$=(s)=>Array.from(document.querySelectorAll(s));
const DBG = new URLSearchParams(location.search).get('debug') != null;
function showDiag(){ if(!DBG) return; qs('#diag').style.display='block'; }
function logln(s){ if(!DBG) return; const t=qs('#log'); t.value += (s + "\\n"); t.scrollTop = t.scrollHeight; console.log(s); }
function envLine(){
  const pe = 'onpointerdown' in window, ts = 'ontouchstart' in window, mt=(navigator.maxTouchPoints||0);
  const dpr=(self.devicePixelRatio||1);
  return `env: PE=${pe} TS=${ts} mt=${mt} dpr=${dpr} ua=${navigator.userAgent}`;
}
/* iOS Safariのズーム/長押しメニュー抑止（描画に集中） */
document.addEventListener('gesturestart', e=>e.preventDefault(), {passive:false});
document.addEventListener('contextmenu', e=>{
  if(e.target && (e.target.id==='paint' || e.target.closest('#paint'))) e.preventDefault();
},{passive:false});

/* ====== メイン要素 ====== */
const DPR=Math.max(1, self.devicePixelRatio||1);
const topbar=qs('#topbar'), sidebar=qs('#sidebar'), panel=qs('#panel');
const cvGrid=qs('#grid'), ctxGrid=cvGrid.getContext('2d');
const cvGuide=qs('#guide'), ctxGuide=cvGuide.getContext('2d');
const cv=qs('#paint'), ctx=cv.getContext('2d',{alpha:true});
const viewport=qs('#viewport'), textLayer=qs('#textLayer');

const APP_VERSION='v0.8.0', BUILD_ID='compat-02b-dbg-b2';
document.title=`Note Link — ${APP_VERSION}-${BUILD_ID}`;
qs('#buildText').textContent=`build: ${BUILD_ID}`;

/* ====== レイアウト ====== */
function applyBars(){ const h=Math.round(topbar.getBoundingClientRect().height)||44; document.documentElement.style.setProperty('--topbar-h',h+'px');}
let W=0,H=0, zoom=1; let panX=0, panY=0;
function updateViewportTransform(){ viewport.style.transform=`translate(${panX}px,${panY}px) scale(${zoom})`; }
function resize(){ applyBars(); const r=viewport.getBoundingClientRect(); W=Math.max(1,Math.round(r.width/zoom)); H=Math.max(1,Math.round(r.height/zoom));
  for(const c of [cvGrid,cvGuide,cv]){ c.width=Math.round(W*DPR); c.height=Math.round(H*DPR); c.style.width=(W*zoom)+'px'; c.style.height=(H*zoom)+'px'; }
  drawGrid();
}
addEventListener('resize', resize);
addEventListener('orientationchange', ()=>setTimeout(resize,50));
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(resize,50); });

/* ====== 状態 ====== */
let tool='pen';
const perTool={ pen:{color:'#cbe58a',size:4,alpha:1,cap:'butt',straight:false},
  marker:{color:'#cbe58a',size:16,alpha:.4,cap:'butt',straight:false}, eraser:{size:24}, hand:{}, keyboard:{} };
let color=perTool.pen.color, size=perTool.pen.size, alpha=1, cap='butt';
let straightToggle=false, straightKey=false;
let gridOn=false, gridStepMM=10, gridColor='#3a4f7a', gridFirst=false;

/* ペン拡張 */
let palmReject=true, pressureOn=true, tiltOn=true;
const penRecent={active:false, ts:0};

/* ====== ツール切替 ====== */
function saveToolState(k){const p=perTool[k]||(perTool[k]={}); p.color=color; p.size=size; p.alpha=alpha; p.cap=cap; p.straight=!!straightToggle;}
function loadToolState(k){const p=perTool[k]||{}; color=p.color??color; size=p.size??size; alpha=p.alpha??alpha; cap=p.cap??cap; straightToggle=!!p.straight;}
function setActiveTool(t){
  saveToolState(tool); tool=t; loadToolState(t);
  $$('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===t));
  qs('#panelTool').textContent=t;
  qs('#rowAlpha').style.display   = (t==='marker') ? '' : 'none';
  qs('#rowLineCap').style.display = (t==='marker'||t==='pen') ? '' : 'none';
  qs('#rowStraight').style.display= (t==='pen'||t==='marker') ? '' : 'none';
  qs('#rowTextOps').style.display = (t==='keyboard') ? '' : 'none';
  qs('#rowSize').style.display    = (t==='pen'||t==='marker'||t==='eraser') ? '' : 'none';
  qs('#rowPenExt').style.display  = (t==='pen'||t==='marker') ? '' : 'none';
  syncUI();
}
qs('#btnSidebarToggle').addEventListener('click', e=>{ e.stopPropagation(); sidebar.classList.toggle('collapsed'); });

$$('.tool').forEach(btn=>{
  if(btn.id==='btnSidebarToggle') return;
  btn.addEventListener('click', e=>{
    e.stopPropagation();
    const t=btn.dataset.tool;
    if(t==='settings'){
      const show=!panel.classList.contains('show');
      panel.classList.toggle('show', show);
      btn.classList.toggle('active', show);
      logln('ui: settings ' + (show?'open':'close'));
      return;
    }
    setActiveTool(t);
  });
});

/* ====== パネル：ドラッグ＆閉じる（☒） ====== */
(()=>{
  const handle=qs('#panelHandle'); let dragging=false, sx=0, sy=0, ox=0, oy=0, id=0;
  function down(e){ if(e.target.closest('#panelClose')) return; dragging=true; id=e.pointerId||1;
    try{panel.setPointerCapture(id)}catch{}; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; e.preventDefault(); }
  function move(e){ if(!dragging) return; const nx=ox+(e.clientX-sx), ny=oy+(e.clientY-sy);
    panel.style.left=Math.max(56,nx)+'px'; const top=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--topbar-h'))+6; panel.style.top=Math.max(top,ny)+'px'; }
  function up(e){ dragging=false; try{panel.releasePointerCapture(id)}catch{} }
  handle.addEventListener('pointerdown',down,{passive:false});
  panel.addEventListener('pointermove',move,{passive:false});
  panel.addEventListener('pointerup',up,{passive:false});
  panel.addEventListener('pointercancel',up,{passive:false});
  qs('#panelClose').addEventListener('pointerdown', e=>{ e.stopPropagation(); }, {passive:false});
  qs('#panelClose').addEventListener('click', e=>{ e.stopPropagation(); panel.classList.remove('show'); $$('.tool[data-tool="settings"]').forEach(b=>b.classList.remove('active')); logln('ui: settings close via ☒'); });
  addEventListener('keydown', e=>{ if(e.key==='Escape' && panel.classList.contains('show')){ qs('#panelClose').click(); } });
})();

/* ====== パネル inputs ====== */
const ui={ color:qs('#uiColor'), size:qs('#uiSize'), alpha:qs('#uiAlpha'),
  sizeVal:qs('#uiSizeVal'), alphaVal:qs('#uiAlphaVal'), cap:qs('#uiCap'),
  straight:qs('#uiStraight'), gridFirst:qs('#uiGridFirst'),
  gOn:qs('#uiGrid'), gStep:qs('#uiGridStep'), gColor:qs('#uiGridColor'),
  palm:qs('#uiPalm'), pressure:qs('#uiPressure'), tilt:qs('#uiTilt')
};
function pxToMm(px){ return px*25.4/96 }
function syncUI(){ ui.color.value=color; ui.size.value=size; ui.sizeVal.textContent=`${size}px (${pxToMm(size).toFixed(2)} mm)`;
  ui.alpha.value=Math.round(alpha*100); ui.alphaVal.textContent=Math.round(alpha*100)+'%';
  ui.cap.value=cap; ui.straight.checked=straightToggle; ui.gridFirst.checked=gridFirst;
  ui.gOn.checked=gridOn; ui.gStep.value=String(gridStepMM); ui.gColor.value=gridColor;
  ui.palm.checked=palmReject; ui.pressure.checked=pressureOn; ui.tilt.checked=tiltOn; }
function onPanelChange(){ color=ui.color.value; size=+ui.size.value; ui.sizeVal.textContent=`${size}px (${pxToMm(size).toFixed(2)} mm)`;
  alpha=+ui.alpha.value/100; ui.alphaVal.textContent=Math.round(alpha*100)+'%';
  cap=ui.cap.value; straightToggle=ui.straight.checked; gridFirst=ui.gridFirst.checked;
  gridOn=ui.gOn.checked; gridStepMM=+ui.gStep.value; gridColor=ui.gColor.value;
  palmReject=ui.palm.checked; pressureOn=ui.pressure.checked; tilt=ui.tilt;
  drawGrid(); }
Object.values(ui).forEach(el=>el.addEventListener('input',onPanelChange));

/* ====== ズーム ====== */
function setZoom(z){ zoom=Math.max(0.5,Math.min(3,z)); qs('#btnZoomReset').textContent=Math.round(zoom*100)+'%'; updateViewportTransform(); resize(); }
qs('#btnZoomIn').addEventListener('click',()=>setZoom(zoom+0.1));
qs('#btnZoomOut').addEventListener('click',()=>setZoom(zoom-0.1));
qs('#btnZoomReset').addEventListener('click',()=>setZoom(1));

/* ====== グリッド ====== */
function clear(c){ c.getContext('2d').clearRect(0,0,c.width,c.height) }
function mmToPx(mm){ return mm*96/25.4*DPR }
function drawGrid(){ clear(cvGrid); if(!gridOn) return;
  const step=mmToPx(gridStepMM), s=ctxGrid, ox=0.5*DPR, oy=0.5*DPR;
  s.save(); s.lineWidth=1; s.strokeStyle=gridColor+'CC'; s.beginPath();
  for(let x=ox;x<=cvGrid.width;x+=step){ s.moveTo(x,0); s.lineTo(x,cvGrid.height); }
  for(let y=oy;y<=cvGrid.height;y+=step){ s.moveTo(0,y); s.lineTo(cvGrid.width,y); }
  s.stroke(); s.restore();
}

/* ====== 描画 ====== */
function setCtx(){
  ctx.lineCap=(tool==='marker'||tool==='pen')?cap:'round';
  if(tool==='marker'){ ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=hexA(color,alpha) }
  else if(tool==='pen'){ ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=color }
  else if(tool==='eraser'){ ctx.globalCompositeOperation='destination-out'; ctx.strokeStyle='#000' }
  ctx.lineWidth=(size||4)*DPR;
}
function hexA(hex,a){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex)||['','cc','e5','8a']; const r=parseInt(m[1],16),g=parseInt(m[2],16),b=parseInt(m[3],16); return `rgba(${r},${g},${b},${a??1})`;}
function pt(e){ const r=cv.getBoundingClientRect(); return {x:(e.clientX-r.left)/zoom*DPR, y:(e.clientY-r.top)/zoom*DPR} }
function snapToGrid(p){ if(!gridOn) return p; const g=mmToPx(gridStepMM); return { x:Math.round(p.x/g)*g, y:Math.round(p.y/g)*g }; }
function snapLine(p0,p1){
  if(gridFirst){ const a0=snapToGrid(p0), a1=snapToGrid(p1); return {x=a1.x,y=a1.y,ang:Math.atan2(a1.y-a0.y,a1.x-a0.x)}; }
  const dx=p1.x-p0.x, dy=p1.y-p0.y, step=Math.PI/12; let ang=Math.round(Math.atan2(dy,dx)/step)*step;
  let len=Math.hypot(dx,dy), x=p0.x+Math.cos(ang)*len, y=p0.y+Math.sin(ang)*len; if(gridOn){ ({x,y}=snapToGrid({x,y})); } return {x,y,ang};
}
function drawHUD(p,ang){
  clear(cvGuide); const s=ctxGuide, d=DPR; s.save(); s.translate(p.x,p.y);
  s.fillStyle='rgba(0,0,0,.65)'; s.strokeStyle='#ddd'; s.lineWidth=1.2*d;
  s.beginPath(); s.rect(-28*d,-16*d,56*d,22*d); s.fill(); s.stroke();
  s.fillStyle='#fff'; s.font=(12*d)+'px system-ui'; s.textAlign='center'; s.textBaseline='middle';
  const deg=(ang*180/Math.PI); s.fillText((deg>=0?'+':'')+Math.round(deg)+'°',0,-5*d); s.restore();
}

/* 履歴 */
const hist=[], redoStack=[];
function snapshot(){ return { url: cv.toDataURL(), texts: textLayer.innerHTML }; }
function pushHistory(){ hist.push(snapshot()); if(hist.length>10) hist.shift(); redoStack.length=0; }
async function restore(snap){ clear(cv); textLayer.innerHTML=snap?.texts||''; if(!snap?.url) return;
  await new Promise(res=>{ const img=new Image(); img.onload=()=>{ ctx.drawImage(img,0,0); res(); }; img.src=snap.url; });
}
async function undo(){ if(!hist.length) return; const cur=snapshot(); const prev=hist.pop(); redoStack.push(cur); await restore(prev); }
async function redo(){ const next=redoStack.pop(); if(!next) return; hist.push(snapshot()); await restore(next); }
qs('#btnUndo').addEventListener('click',()=>undo()); qs('#btnRedo').addEventListener('click',()=>redo());

/* パームリジェクション＆圧力・傾き */
function isPalmTouch(e){
  if(!palmReject) return false;
  const now=performance.now();
  if(e.pointerType==='touch' && penRecent.active && (now-penRecent.ts)<1200){
    logln(`PALM: ignore (recent-pen ${Math.round(now-penRecent.ts)}ms) area=${(e.width||0)*(e.height||0)}`);
    return true;
  }
  const area=(e.width||0)*(e.height||0);
  if(e.pointerType==='touch' && area>1200){
    logln(`PALM: ignore (area>${1200}) area=${area}`);
    return true;
  }
  return false;
}
function dynamicWidthFromPen(e, basePx){
  let w=basePx;
  if(pressureOn && typeof e.pressure==='number'){ const p=Math.max(0.05, Math.min(1, e.pressure||0.5)); w = basePx * (0.4 + 0.9*p); }
  if(tiltOn){ const t=Math.hypot(e.tiltX||0, e.tiltY||0)/90; const k=(tool==='marker'?0.9:0.4); w *= (1 + k*Math.min(1,t)); }
  return w;
}
function updatePenRecent(e){ if(e.pointerType==='pen'){ penRecent.active=true; penRecent.ts=performance.now(); } }

/* ポインタ */
cv.style.touchAction='none';
let drawing=false, startPt=null, panning=false;

function onDown(e){
  updatePenRecent(e);
  if(isPalmTouch(e)) return;
  if(tool==='hand'){ panning=true; try{cv.setPointerCapture(e.pointerId);}catch{}; return; }
  e.preventDefault(); try{cv.setPointerCapture(e.pointerId);}catch{}
  setCtx(); ctx.lineWidth = dynamicWidthFromPen(e,(size||4))*DPR;
  const p=pt(e); const straight=(straightKey || qs('#uiStraight').checked);
  startPt=(gridFirst && straight)?snapToGrid(p):p; drawing=true;
  if(!straight){ ctx.beginPath(); ctx.moveTo(startPt.x,startPt.y); }
  pushHistory();
  logln(`evt: pointerdown type=${e.pointerType||'?'} pres=${e.pressure??'?'} w=${e.width||0} h=${e.height||0}`);
}
function onMove(e){
  updatePenRecent(e);
  if(isPalmTouch(e)) return;
  if(tool==='hand' && panning){
    if(typeof e.movementX==='number'){ panX+=e.movementX; panY+=e.movementY; }
    else{ if(!onMove._last) onMove._last={x:e.clientX,y:e.clientY};
      panX += e.clientX-onMove._last.x; panY += e.clientY-onMove._last.y; onMove._last={x:e.clientX,y:e.clientY}; }
    updateViewportTransform(); return;
  }
  if(!drawing) return;
  ctx.lineWidth = dynamicWidthFromPen(e,(size||4))*DPR;
  const p=pt(e); const straight=(straightKey || qs('#uiStraight').checked);
  if(!straight){ ctx.lineTo(p.x,p.y); ctx.stroke(); return; }
  const sp=snapLine(startPt,p);
  clear(cvGuide); const g=ctxGuide,d=DPR;
  g.save(); g.lineCap=ctx.lineCap; g.lineWidth=ctx.lineWidth; g.strokeStyle='#7ec8ff';
  g.setLineDash([6*d,6*d]); g.beginPath(); g.moveTo(startPt.x,startPt.y); g.lineTo(sp.x,sp.y); g.stroke(); g.restore();
}
function onUp(e){
  updatePenRecent(e);
  if(tool==='hand' && panning){ panning=false; onMove._last=null; return; }
  if(!drawing){ clear(cvGuide); return; }
  const straight=(straightKey || qs('#uiStraight').checked);
  if(straight){ const p=pt(e); const sp=snapLine(startPt,p); setCtx(); ctx.lineWidth = dynamicWidthFromPen(e,(size||4))*DPR;
    ctx.beginPath(); ctx.moveTo(startPt.x,startPt.y); ctx.lineTo(sp.x,sp.y); ctx.stroke(); }
  drawing=false; startPt=null; clear(cvGuide);
  logln(`evt: pointerup type=${e.pointerType||'?'} pres=${e.pressure??'?'} w=${e.width||0} h=${e.height||0}`);
}

/* PointerEvent */
cv.addEventListener('pointerdown',      onDown, {passive:false});
cv.addEventListener('pointermove',      onMove, {passive:false});
cv.addEventListener('pointerrawupdate', onMove, {passive:false});
cv.addEventListener('pointerup',        onUp,   {passive:false});
cv.addEventListener('pointercancel',    onUp,   {passive:false});

/* キー（直線モード切替） */
addEventListener('keydown',e=>{ if(e.key==='Shift') straightKey=true; });
addEventListener('keyup',e=>{ if(e.key==='Shift') straightKey=false; });

/* テキスト */
function addText(){ const el=document.createElement('div'); el.className='note-text'; el.contentEditable='true';
  el.style.left=(90+Math.random()*40)+'px'; el.style.top=(70+Math.random()*40)+'px'; el.textContent='テキスト';
  const del=document.createElement('button'); del.className='del'; del.textContent='削除'; del.addEventListener('click',()=>el.remove()); el.appendChild(del);
  textLayer.appendChild(el); setTimeout(()=>el.focus(),0); }
qs('#btnTextAdd').addEventListener('click', addText);
qs('#btnTextBold').addEventListener('click',()=>document.execCommand('bold',false,null));
qs('#btnTextIt').addEventListener('click',()=>document.execCommand('italic',false,null));
qs('#btnTextDel').addEventListener('click',()=>document.execCommand('delete',false,null));
qs('#btnTextBoxDel').addEventListener('click',()=>{ const sel=window.getSelection(); if(!sel.rangeCount) return;
  let el=sel.anchorNode; while(el && !(el instanceof HTMLElement && el.classList.contains('note-text'))) el=el.parentNode; if(el) el.remove(); });

/* 出力 */
function composite(){
  const out=document.createElement('canvas'); out.width=cv.width; out.height=cv.height; const o=out.getContext('2d');
  o.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()||'#0b1020'; o.fillRect(0,0,out.width,out.height);
  o.drawImage(cvGrid,0,0); o.drawImage(cv,0,0);
  [...textLayer.querySelectorAll('.note-text')].forEach(n=>{
    const r=n.getBoundingClientRect(), L=textLayer.getBoundingClientRect(); const x=((r.left-L.left)/zoom)*DPR, y=((r.top-L.top)/zoom)*DPR;
    o.fillStyle='#eaf3ff'; o.font=(16*DPR)+'px system-ui'; o.fillText(n.textContent.trim(), x, y+16*DPR);
  });
  return out;
}
qs('#btnPng').addEventListener('click',()=>composite().toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='note-link.png';a.click();setTimeout(()=>URL.revokeObjectURL(a.href),800)}));
qs('#btnPrint').addEventListener('click',()=>window.print());
qs('#btnShare').addEventListener('click',()=>{ composite().toBlob(async b=>{ const f=new File([b],'note.png',{type:'image/png'});
  if(navigator.share && navigator.canShare && navigator.canShare({files:[f]})){ try{ await navigator.share({files:[f],title:'Note Link'});}catch(e){} }
  else{ const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='note-link.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(u),800); } }); });

/* ====== 起動（※関数名と状態名を分離：衝突バグの再発防止） ====== */
function boot(){
  showDiag();
  qs('#env').textContent = ' / ' + envLine();
  qs('#btnCopy').onclick = ()=>{ const t=qs('#log'); t.select(); document.execCommand('copy'); };
  qs('#btnClear').onclick = ()=>{ qs('#log').value=''; };
  applyBars(); updateViewportTransform(); setTimeout(resize,0);
  setActiveTool('pen'); panel.classList.remove('show'); $$('.tool[data-tool="settings"]').forEach(b=>b.classList.remove('active'));
  logln('INIT: ready ' + BUILD_ID);
  setTimeout(()=>{ if(!bootState.pd){ logln('ERR: no-pointerdown (入力イベントが届いていません)'); } }, 4000);
}
const bootState={pd:false};
cv.addEventListener('pointerdown', ()=>{ bootState.pd=true; }, {once:true});
boot();
</script>
</body></html>
